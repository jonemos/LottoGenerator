<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lotto 6/45 추천번호</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="lotto-container">
    <div class="lotto-header">
      <h1>동행복권<br><span>Lotto 6/45</span></h1>
    </div>

    <div class="lotto-grid">
      {% for i in range(1, 46) %}
      <div class="lotto-number">{{ i }}</div>
      {% endfor %}
    </div>

    <div class="recommend-section">
      <p>추천번호</p>
      <div class="recommend-numbers" id="recommend-numbers">
        {% for numbers in lotto_numbers %}
          {% for number in numbers %}
            <div class="lotto-ball-win">{{ number }}</div>
          {% endfor %}
        {% endfor %}
      </div>
      <button class="generate-btn" onclick="generateNewNumbers()">
        🎲 새 번호 생성
      </button>

    </div>

    <div class="results">
      <h2>회차별 당첨번호</h2>
      {% for result in latest_results %}
      <div class="draw-card">
        <div class="draw-header">제 {{ result.draw_no }} 회</div>
        <div class="draw-numbers">
          {% for num in result.numbers %}
            <div class="lotto-ball" style="{{ get_ball_style(num) }}">{{ num }}</div>
          {% endfor %}
          <span class="plus">+</span>
          <div class="lotto-ball bonus" style="{{ get_ball_style(result.bonus) }}">{{ result.bonus }}</div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="results">
      <h2>최근 100회 출현 빈도 TOP</h2>
      <div style="font-size: 12px; color: #555; text-align: center; margin-bottom: 10px;" id="updated-date"></div>
      <div class="draw-numbers" id="top-frequent-numbers">
        <!-- JS가 채움 -->
      </div>

      <h2>출현 상위 30개 중 추천번호</h2>
      <div class="recommend-numbers" id="top20-recommend">
        {% for number in top_20_recommend %}
          <div class="lotto-ball-win" style="{{ get_ball_style(number) }}">{{ number }}</div>
        {% endfor %}
      </div>
      <div style="display: flex; justify-content: center; margin-top: 10px;">
        <button class="generate-btn" onclick="refreshTop20Recommend()">🎲 다시 추천</button>
      </div>
      <p id="ac-value-display" style="text-align:center; font-size:14px; color:#555; margin-top:10px;"></p>
    </div>

    
  </div>

  <script>
    function generateNewNumbers() {
      fetch('/generate-numbers')
        .then(response => response.json())
        .then(data => {
          const recommendBox = document.getElementById('recommend-numbers');
          recommendBox.innerHTML = '';

          const recommendedSet = new Set(); // 추천번호 저장
          data.lotto_numbers.forEach(numbers => {
            numbers.forEach(num => {
              const ball = document.createElement('div');
              ball.className = 'lotto-ball-win';
              ball.textContent = num;

              // 공 색상 적용
              if (num <= 10) {
                ball.style.backgroundColor = '#fbc400'; // Yellow
                ball.style.color = '#000';
              } else if (num <= 20) {
                ball.style.backgroundColor = '#69c8f2'; // Blue
                ball.style.color = '#000';
              } else if (num <= 30) {
                ball.style.backgroundColor = '#ff7272'; // Red
                ball.style.color = '#000';
              } else if (num <= 40) {
                ball.style.backgroundColor = '#aaa'; // Gray
                ball.style.color = '#000';
              } else {
                ball.style.backgroundColor = '#b0d840'; // Green
                ball.style.color = '#000';
              }

              recommendBox.appendChild(ball);
              recommendedSet.add(num);
            });
          });

          // 버튼 강조 처리
          const allButtons = document.querySelectorAll('.lotto-number');
          allButtons.forEach(btn => {
            const num = parseInt(btn.textContent);
            if (recommendedSet.has(num)) {
              btn.style.backgroundColor = '#333';
              btn.style.color = '#fff';
              btn.style.fontWeight = 'bold';
            } else {
              btn.style.backgroundColor = '#fff';
              btn.style.color = '#f27171';
              btn.style.fontWeight = 'normal';
            }
          });
        })
        .catch(error => console.error('Error:', error));
    }
    function loadTopFrequentNumbers() {
      fetch('/top-frequent-numbers')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('top-frequent-numbers');
          container.innerHTML = '';

          // ✅ updated 표시
          const updatedDate = document.getElementById('updated-date');
          if (data.updated) {
            const dateObj = new Date(data.updated);
            const formatted = dateObj.toLocaleString('ko-KR', {
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit'
            });
            updatedDate.textContent = `갱신일: ${formatted}`;
          }

          data.top_numbers.forEach(([num, count]) => {
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'center';
            wrapper.style.fontSize = '12px';
            wrapper.style.margin = '5px';

            const ball = document.createElement('div');
            ball.className = 'lotto-ball';
            ball.textContent = num;

            if (num <= 10) ball.style.backgroundColor = '#fbc400';
            else if (num <= 20) ball.style.backgroundColor = '#69c8f2';
            else if (num <= 30) ball.style.backgroundColor = '#ff7272';
            else if (num <= 40) ball.style.backgroundColor = '#aaa';
            else ball.style.backgroundColor = '#b0d840';
            ball.style.color = '#000';

            const countText = document.createElement('div');
            countText.textContent = `${count}회`;

            wrapper.appendChild(ball);
            wrapper.appendChild(countText);
            container.appendChild(wrapper);
          });
        })
        .catch(err => console.error('출현 빈도 불러오기 실패', err));
    }
    function refreshTop20Recommend() {
      fetch('/generate-from-top20')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('top20-recommend');
          const acValueDisplay = document.getElementById('ac-value-display');
          container.innerHTML = '';
          let differences = new Set();

          data.numbers.forEach((num, i) => {
            const ball = document.createElement('div');
            ball.className = 'lotto-ball-win';
            ball.textContent = num;

            if (num <= 10) ball.style.backgroundColor = '#fbc400';
            else if (num <= 20) ball.style.backgroundColor = '#69c8f2';
            else if (num <= 30) ball.style.backgroundColor = '#ff7272';
            else if (num <= 40) ball.style.backgroundColor = '#aaa';
            else ball.style.backgroundColor = '#b0d840';
            ball.style.color = '#000';
            container.appendChild(ball);

            for (let j = 0; j < i; j++) {
              differences.add(Math.abs(data.numbers[j] - num));
            }
          });
          acValueDisplay.textContent = `AC값: ${differences.size}`;
        })
        .catch(err => console.error('Top 20 추천번호 새로고침 실패', err));
    }
   
      window.onload = function () {
      generateNewNumbers(); // 기존 추천번호도 새로 불러옴
      loadTopFrequentNumbers(); // 추가된 기능 실행
    }
  
  </script>
</body>
</html>
